@startuml
skinparam actorStyle awesome
autonumber
autonumber 1.1

actor "Solana Network" as Solana

box "Indexer Service" #E3F2FD
    participant "DlnIndexer" as Indexer
    participant "PostgreSQL (Tasks)" as DB_Tasks
end box

box "Processor Service" #F1F8E9
    participant "DlnProcessor" as Processor
    participant "DataExtractor" as Extractor
    participant "PriceService" as Price
    participant "Jupiter V3 API" as Jupiter
    participant "PostgreSQL (Logs)" as DB_Logs
end box

box "Frontend & Ops" #F3E5F5
    participant "Next.js UI" as UI
    participant "Prometheus" as Prom
end box

== 1. Этап Индексации (Сбор данных) ==

Indexer -> Solana : Get Signatures (Create/Fulfill)
Solana --> Indexer : Transaction Logs & Data
Indexer -> DB_Tasks : Create Task (Status: PENDING, Raw Data)
Indexer -> Prom : Inc(tx_saved_total)

== 2. Этап Обработки (Процессинг и Цены) ==

Processor -> DB_Tasks : Fetch PENDING tasks
Processor -> Extractor : Parse Logs (Extract OrderId, Token, Amount)
Extractor --> Processor : Decoded Data

    group Расчет стоимости (Кеширование)
        Processor -> Price : GetPrice(TokenAddress)
        Price -> DB_Logs : Check cached price (TTL 15 min)
        
        alt Кэш просрочен или отсутствует
            Price -> Jupiter : Fetch Price (x-api-key)
            Jupiter --> Price : USD Price Data
            Price -> DB_Logs : Upsert TokenPrice (Cache Update)
        else Кэш валиден
            DB_Logs --> Price : Return cached price
        end
        Price --> Processor : Big.js Price
    end

Processor -> Processor : Calculate Volume (Amount * Price)
Processor -> DB_Logs : Save Final Financial Log (OrderId, USD Value)
Processor -> DB_Tasks : Update Task (Status: READY)
Processor -> Prom : Inc(processor_processed_tasks_total)

== 3. Визуализация ==

UI -> DB_Logs : Query with Filters (Date Range, Event Types)
DB_Logs --> UI : Financial Stats & Chart Data
UI -> UI : Render Dashboard

@enduml